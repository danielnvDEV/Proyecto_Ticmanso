@using System.Net.Http.Json
@using TicmansoCrud.Shared
@using TicmansoWebAPI.Models
@using TicmansoWebAPI
@using MudBlazor
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using System.Text;
@using Blazored.SessionStorage
@using System.IdentityModel.Tokens.Jwt;



@inject HttpClient httpClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar

@page "/management/tickets/newTicket"
<PageTitle>New ticket</PageTitle>

<EditForm Model="@ticket" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <MudCard>
        <MudCardContent>
            <MudTextField @bind-Value="ticket.Title" Label="Título" Variant="Variant.Outlined" Required="true" />
            <MudTextField @bind-Value="ticket.Description" Label="Descripción" Variant="Variant.Outlined" Required="true" Lines="5" />

            <MudSelect T="long" Label="Prioridad" Variant="Variant.Outlined" Required="true" @bind-Value="ticket.PriorityId">
                @foreach (var priority in priorities)
                {
                    <MudSelectItem Value="@priority.Id">@priority.Name</MudSelectItem>
                }
            </MudSelect>
        </MudCardContent>
        <MudCardActions>
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Crear ticket</MudButton>
        </MudCardActions>
    </MudCard>
</EditForm>
@inject SessionStorageServiceDTO SessionStorage
@code {
    private TicketDTO ticket = new TicketDTO();
    private List<PriorityDTO> priorities = new List<PriorityDTO>();
    private List<StatusDTO> statuses = new List<StatusDTO>();
    MudForm form;
    protected override async Task OnInitializedAsync()
    {
        priorities = await httpClient.GetFromJsonAsync<List<PriorityDTO>>("https://localhost:7144/api/Ticmanso/priority");
        statuses = await httpClient.GetFromJsonAsync<List<StatusDTO>>("https://localhost:7144/api/Ticmanso/status");
    }

    private async Task HandleSubmit()
    {
        var token = await SessionStorage.GetItemAsync<string>("token");
        var handler = new JwtSecurityTokenHandler();
        var jwtToken = handler.ReadJwtToken(token);
        long userId = long.Parse(jwtToken.Claims.First(c => c.Type == "NameIdentifier").Value);
        string username = jwtToken.Claims.First(c => c.Type == "name").Value;
        List<string> roles = jwtToken.Claims.Where(c => c.Type == "role").Select(c => c.Value).ToList();

        ticket.CreationDate = DateTime.Now;
        ticket.CreationUserId = userId;
        ticket.ChatId = 1;
        ticket.StatusId = 1;

        try
        {
            var response = await httpClient.PostAsJsonAsync("https://localhost:7144/api/Ticmanso/ticket", ticket);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("ticket create successfully!", Severity.Success);

            }
            else
            {
                string errorMessage = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"create failed: {errorMessage}", Severity.Error);
            }
        }
        catch (HttpRequestException ex)
        {
            Snackbar.Add($"Error contacting the server: {ex.Message}", Severity.Error);
        }
    }
}
