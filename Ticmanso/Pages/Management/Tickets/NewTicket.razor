@using System.Net.Http.Json
@using TicmansoCrud.Shared
@using TicmansoWebAPI.Models
@using TicmansoWebAPI
@using MudBlazor
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using System.Text;
@using Blazored.SessionStorage
@using System.IdentityModel.Tokens.Jwt;
@using Newtonsoft.Json.Linq;
@using System.Security.Claims




@inject HttpClient httpClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar

@page "/management/tickets/newTicket"
<PageTitle>New ticket</PageTitle>

<EditForm Model="@ticket" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <MudCard>
        <MudCardContent>
            <MudTextField @bind-Value="ticket.Title" Label="Título" Variant="Variant.Outlined" Required="true" />
            <MudTextField @bind-Value="ticket.Description" Label="Descripción" Variant="Variant.Outlined" Required="true" Lines="5" />

            <MudSelect T="long" Label="Prioridad" Variant="Variant.Outlined" Required="true" @bind-Value="ticket.PriorityId">
                @foreach (var priority in priorities)
                {
                    <MudSelectItem Value="@priority.Id">@priority.Name</MudSelectItem>
                }
            </MudSelect>
        </MudCardContent>
        <MudCardActions>
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Crear ticket</MudButton>
        </MudCardActions>
    </MudCard>
</EditForm>
@inject SessionStorageServiceDTO SessionStorage
@code {
    private TicketDTO ticket = new TicketDTO();
    private List<PriorityDTO> priorities = new List<PriorityDTO>();
    private List<StatusDTO> statuses = new List<StatusDTO>();
    MudForm form;


    long userId = 0;

    private JwtSecurityToken DecodeJwtToken(string token)
    {
        var tokenHandler = new JwtSecurityTokenHandler();
        var jwtToken = tokenHandler.ReadJwtToken(token);
        return jwtToken;
    }

    protected override async Task OnInitializedAsync()
    {
        var tokenString  = await SessionStorage.GetItemAsync<string>("token");
        if (!string.IsNullOrEmpty(tokenString))
        {
            try
            {
                var tokenObject = JObject.Parse(tokenString);
                var token = tokenObject["token"].ToString();
                var jwtToken = DecodeJwtToken(token);

                userId = long.Parse(jwtToken.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value);
                var userName = jwtToken.Claims.First(c => c.Type == ClaimTypes.Name).Value;
                var userSurnames = jwtToken.Claims.First(c => c.Type == ClaimTypes.Surname).Value;
                var userEmail = jwtToken.Claims.First(c => c.Type == ClaimTypes.Email).Value;
                var userCompanyId = jwtToken.Claims.First(c => c.Type == ClaimTypes.UserData).Value;
                var userRoleId = jwtToken.Claims.First(c => c.Type == ClaimTypes.Role).Value;

            }
            catch (ArgumentException ex)
            {
                // Handle the token parsing error
                Console.WriteLine($"Error parsing JWT token: {ex.Message}");
                // You can choose to log the error, display an error message, or take appropriate action
            }
        }

        priorities = await httpClient.GetFromJsonAsync<List<PriorityDTO>>("https://localhost:7144/api/Ticmanso/priority");
        statuses = await httpClient.GetFromJsonAsync<List<StatusDTO>>("https://localhost:7144/api/Ticmanso/status");
    }


    private async Task HandleSubmit()
    {
       

        ticket.CreationDate = DateTime.Now;
        ticket.CreationUserId = userId;
        ticket.ChatId = 1;
        ticket.StatusId = 1;

        try
        {
            var response = await httpClient.PostAsJsonAsync("https://localhost:7144/api/Ticmanso/ticket", ticket);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("ticket create successfully!", Severity.Success);

            }
            else
            {
                string errorMessage = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"create failed: {errorMessage}", Severity.Error);
            }
        }
        catch (HttpRequestException ex)
        {
            Snackbar.Add($"Error contacting the server: {ex.Message}", Severity.Error);
        }
    }
}
