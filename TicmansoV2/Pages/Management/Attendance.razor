@page "/attendance"
@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@using TicmansoV2.Shared
@using System.Globalization;

@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime
<PageTitle>Attendance</PageTitle>
<AuthorizeView>
    <Authorized Context="authContext">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">Fichar</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudText>Fecha: @currentDate.ToString("yyyy-MM-dd")</MudText>
                <MudText>Hora de entrada: @entryTime.ToString("HH:mm:ss")</MudText>
                <MudText>Hora de salida: @departureTime?.ToString("HH:mm:ss")</MudText>
            </MudCardContent>
            <MudCardActions>
                @if (entryTime == null)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="StartWorkday">Iniciar jornada</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="EndWorkday">Finalizar jornada</MudButton>
                }
                else if (departureTime == null)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="EndWorkday">Finalizar jornada</MudButton>
                }
                else
                {
                    <MudText>Jornada finalizada.</MudText>
                }
            </MudCardActions>
        </MudCard>
    </Authorized>
</AuthorizeView>

@code {
    private DateTime currentDate = DateTime.Today;
    private DateTime entryTime;
    private DateTime? departureTime;
    private string userId;
    private AttendanceDTO attendace = new AttendanceDTO();

    protected override async Task OnInitializedAsync()
    {
        await GetUserId();
        await LoadAttendance();
    }

    private async Task GetUserId()
    {
        var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "token");
        var handler = new JwtSecurityTokenHandler();
        var jwtToken = handler.ReadJwtToken(token);
        var claims = jwtToken.Claims;
        userId = claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
    }

    private async Task LoadAttendance()
    {
        try
        {
           var response = await HttpClient.GetFromJsonAsync<AttendanceDTO>($"https://localhost:7291/api/Attendances/{currentDate:yyyy-MM-dd}/{userId}");

                if (response != null)
                {                  
                    entryTime = response.EntryTime;
                    departureTime = response.DepartureTime;                   
                }

        }
        catch (Exception ex)
        {
            // Manejar cualquier excepción durante la deserialización
            Console.WriteLine($"Error al procesar la respuesta: {ex.Message}");
        }
    }

    private async Task StartWorkday()
    {

        var attendance = new AttendanceDTO
        {
            Date = currentDate,
            EntryTime = DateTime.Now,
            UserId = userId
        };

        var response = await HttpClient.PostAsJsonAsync("https://localhost:7291/api/Attendances", attendance);
        if (response.IsSuccessStatusCode)
        {
            entryTime = attendance.EntryTime;
        }
        else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
        {
            // Manejar el caso de un registro de asistencia duplicado
            // Puedes mostrar un mensaje de error o realizar alguna acción específica
            Console.WriteLine("Ya existe un registro de asistencia para la fecha y el usuario especificados.");
        }
        else
        {
            // Manejar otros errores de la API si es necesario
            Console.WriteLine("Error al crear el registro de asistencia.");
        }
    }

    private async Task EndWorkday()
    {

         var responseDATE = await HttpClient.GetFromJsonAsync<AttendanceDTO>($"https://localhost:7291/api/Attendances/{currentDate:yyyy-MM-dd}/{userId}");

                if (responseDATE != null)
                {                  
                    entryTime = responseDATE.EntryTime;
                    departureTime = responseDATE.DepartureTime;                   
                }

        var attendance = new AttendanceDTO
        {
            Date = currentDate,
            EntryTime = entryTime,
            DepartureTime = DateTime.Now,
            UserId = userId
        };

        var response = await HttpClient.PutAsJsonAsync($"https://localhost:7291/api/Attendances/{currentDate:yyyy-MM-dd}/{userId}", attendance);
        if (response.IsSuccessStatusCode)
        {
            departureTime = attendance.DepartureTime;
        }
    }
}