@page "/attendance"
@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@using TicmansoV2.Shared
@using System.Globalization;
@using Microsoft.JSInterop

@inject HttpClient HttpClient
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar

<PageTitle>Attendance</PageTitle>
<AuthorizeView>
    <Authorized Context="authContext">
        <MudCard>
            <MudCardHeader>
                <MudText Typo="Typo.h6">Fichar</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudText>Fecha: @currentDate.ToString("yyyy-MM-dd")</MudText>
                <MudText>Hora de entrada: @entryTime.ToString("HH:mm:ss")</MudText>
                <MudText>Hora de salida: @departureTime?.ToString("HH:mm:ss")</MudText>
            </MudCardContent>
            <MudCardActions>
                @if (d == 1)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="StartWorkday">Iniciar jornada</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="EndWorkday">Finalizar jornada</MudButton>
                }
                else if (departureTime == null)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="EndWorkday">Finalizar jornada</MudButton>
                }
                else
                {
                    <MudText>Jornada finalizada.</MudText>
                }
            </MudCardActions>
        </MudCard>
    </Authorized>
</AuthorizeView>

@code {
    private DateTime currentDate = DateTime.Today;
    private DateTime entryTime;
    private DateTime? departureTime;
    private string userId;
    private AttendanceDTO attendace = new AttendanceDTO();
    private double entryLatitude;
    private double entryLongitude;
    private double? departureLatitude;
    private double? departureLongitude;
    private int d;

    protected override async Task OnInitializedAsync()
    {
        await GetUserId();
        await LoadAttendance();
    }

    private async Task GetUserId()
    {
        var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "token");
        var handler = new JwtSecurityTokenHandler();
        var jwtToken = handler.ReadJwtToken(token);
        var claims = jwtToken.Claims;
        userId = claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
    }

    private async Task LoadAttendance()
    {
        try
        {
            var response = await HttpClient.GetAsync($"https://localhost:7291/api/Attendances/{currentDate:yyyy-MM-dd}/{userId}");

            if (response.IsSuccessStatusCode)
            {
                var attendanceDto = await response.Content.ReadFromJsonAsync<AttendanceDTO>();

                if (attendanceDto != null)
                {
                    entryTime = attendanceDto.EntryTime;
                    departureTime = attendanceDto.DepartureTime;
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                Snackbar.Add("No hay registros para la fecha y el usuario especificados.", Severity.Info);
                d = 1;
            }
            else
            {
                Snackbar.Add("Error al cargar los registros de asistencia.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al procesar la respuesta: {ex.Message}");
            Snackbar.Add("Error al cargar los registros de asistencia.", Severity.Error);
        }
    }

    private async Task StartWorkday()
    {

        var position = await GetCurrentPosition();

        var attendance = new AttendanceDTO
        {
            Date = currentDate,
            EntryTime = DateTime.Now,
            UserId = userId,
            EntryLatitude = position.Latitude,
            EntryLongitude = position.Longitude
        };

        var response = await HttpClient.PostAsJsonAsync("https://localhost:7291/api/Attendances", attendance);
        if (response.IsSuccessStatusCode)
        {
            entryTime = attendance.EntryTime;
        }
        else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
        {
            // Manejar el caso de un registro de asistencia duplicado
            // Puedes mostrar un mensaje de error o realizar alguna acción específica
            Console.WriteLine("Ya existe un registro de asistencia para la fecha y el usuario especificados.");
        }
        else
        {
            // Manejar otros errores de la API si es necesario
            Console.WriteLine("Error al crear el registro de asistencia.");
        }
    }

    private async Task EndWorkday()
    {

         var responseDATE = await HttpClient.GetFromJsonAsync<AttendanceDTO>($"https://localhost:7291/api/Attendances/{currentDate:yyyy-MM-dd}/{userId}");

                if (responseDATE != null)
                {                  
                    entryTime = responseDATE.EntryTime;
                    departureTime = responseDATE.DepartureTime;                   
                }

        var position = await GetCurrentPosition();

        var attendance = new AttendanceDTO
        {
            Date = currentDate,
            EntryTime = entryTime,
            DepartureTime = DateTime.Now,
            UserId = userId,
            DepartureLatitude = position.Latitude,
            DepartureLongitude = position.Longitude
        };

        var response = await HttpClient.PutAsJsonAsync($"https://localhost:7291/api/Attendances/{currentDate:yyyy-MM-dd}/{userId}", attendance);
        if (response.IsSuccessStatusCode)
        {
            departureTime = attendance.DepartureTime;
        }
    }
    private async Task<(double Latitude, double Longitude)> GetCurrentPosition()
    {
        var options = new PositionOptions
        {
            EnableHighAccuracy = true,
            Timeout = 5000,
            MaximumAge = 0
        };

        var position = await JSRuntime.InvokeAsync<GeolocationPosition>("navigator.geolocation.getCurrentPosition", DotNetObjectReference.Create(this), options);
        return (position.Coords.Latitude, position.Coords.Longitude);
    }

    [JSInvokable]
    public void GeolocationSuccess(GeolocationPosition position)
    {
        
        entryLatitude = position.Coords.Latitude;
        entryLongitude = position.Coords.Longitude;
    }

    public class PositionOptions
    {
        public bool EnableHighAccuracy { get; set; }
        public int Timeout { get; set; }
        public int MaximumAge { get; set; }
    }
}