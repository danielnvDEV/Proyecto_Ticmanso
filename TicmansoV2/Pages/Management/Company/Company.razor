@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@using TicmansoV2.Shared
@using System.Globalization;
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Components.Authorization;

@page "/management/companies"
@inject HttpClient HttpClient
@inject ISnackbar Snackbar
@inject NavigationManager NavManager
@attribute [Authorize]
<PageTitle>Administrar compañias</PageTitle>
<AuthorizeView Roles="Admin">
    <Authorized Context="authContext">
        <MudTable Items="@companies" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@loading" LoadingProgressColor="Color.Info">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Compañias</MudText>
                <MudSpacer />
                <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenCreateForm">Crear compañias</MudButton>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Id</MudTh>
                <MudTh>Nombre</MudTh>
                <MudTh>Municipio</MudTh>
                <MudTh>Dirección</MudTh>
                <MudTh>Código Postal</MudTh>
                <MudTh>Ciudad</MudTh>
                <MudTh>CIF</MudTh>
                <MudTh>Acciones</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Id">@context.Id</MudTd>
                <MudTd DataLabel="Nombre">@context.Name</MudTd>
                <MudTd DataLabel="Pais">@context.Country</MudTd>
                <MudTd DataLabel="Dirección">@context.Address</MudTd>
                <MudTd DataLabel="Código Postal">@context.PostalCode</MudTd>
                <MudTd DataLabel="Ciudad">@context.City</MudTd>
                <MudTd DataLabel="CIF">@context.Cif</MudTd>
                <MudTd DataLabel="Acciones">
                    <MudButton Color="Color.Default" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditForm(context.Id))">Editar</MudButton>
                    <MudButton Color="Color.Error" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteCompany(context.Id))">Borrar</MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>

        <MudDialog @bind-IsVisible="showForm">
            <TitleContent>
                <MudText Typo="Typo.h6">@(editingCompanyId == 0 ? "Crear compañia" : "Editar compañia")</MudText>
            </TitleContent>
            <DialogContent>
                <MudForm Model="@company" @ref="form">
                    <MudTextField @bind-Value="company.Name" Label="Nombre" Required="true" RequiredError="Nombre requerido" />
                    <MudTextField @bind-Value="company.Country" Label="Pais" Required="true" RequiredError="Municipio requerido" />
                    <MudTextField @bind-Value="company.Address" Label="Dirección" Required="true" RequiredError="Dirección requerida" />
                    <MudTextField @bind-Value="company.PostalCode" Label="Código Postal" Required="true" RequiredError="Codigo postal requerido" />
                    <MudTextField @bind-Value="company.City" Label="Ciudad" Required="true" RequiredError="Ciudad requerida" />
                    <MudTextField @bind-Value="company.Cif" Label="CIF" Required="true" RequiredError="CIF requerido" />
                </MudForm>
            </DialogContent>
            <DialogActions>
                <MudButton OnClick="CloseForm">Cancelar</MudButton>
                <MudButton Color="Color.Primary" OnClick="SaveCompany">Guardar</MudButton>
            </DialogActions>
        </MudDialog>
    </Authorized>
    <NotAuthorized>
        @{NavManager.NavigateTo("/");}
    </NotAuthorized>
</AuthorizeView>
@code {
    private List<CompanyDTO> companies = new List<CompanyDTO>();
    private CompanyDTO company = new CompanyDTO();
    private bool loading = true;
    private bool showForm = false;
    private long editingCompanyId = 0;
    private MudForm form;

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanies();
    }

    private async Task LoadCompanies()
    {
        try
        {
            loading = true;
            companies = await HttpClient.GetFromJsonAsync<List<CompanyDTO>>("api/Company");
            loading = false;
        }
        catch (Exception)
        {
            Snackbar.Add($"Error al cargar los datos", Severity.Error);
        }

    }

    private void OpenCreateForm()
    {
        company = new CompanyDTO();
        editingCompanyId = 0;
        showForm = true;
    }

    private async Task OpenEditForm(long id)
    {
        try
        {
            company = await HttpClient.GetFromJsonAsync<CompanyDTO>($"api/Company/{id}");
            editingCompanyId = id;
            showForm = true;
        }
        catch (Exception)
        {
            Snackbar.Add($"Error al cargar los datos", Severity.Error);
        }

    }

    private void CloseForm()
    {
        showForm = false;
    }

    private async Task SaveCompany()
    {
        try
        {
            if (editingCompanyId == 0)
            {
                await HttpClient.PostAsJsonAsync("api/Company", company);
                Snackbar.Add("Compañia creada", Severity.Success);
            }
            else
            {
                await HttpClient.PutAsJsonAsync($"api/Company/{editingCompanyId}", company);
                Snackbar.Add("Compañia actualizada", Severity.Info);
            }

            showForm = false;
            await LoadCompanies();
        }
        catch (Exception)
        {
            Snackbar.Add("Ha ocurrido un error", Severity.Info);
        }

    }

    private async Task DeleteCompany(int id)
    {
        try
        {
            var result =  await HttpClient.DeleteAsync($"api/Company/{id}");
            if (result.IsSuccessStatusCode)
            {
                Snackbar.Add("Compañia borrada", Severity.Warning);
                await LoadCompanies();
            }

        }
        catch (Exception)
        {
            Snackbar.Add("Compañia borrada", Severity.Warning);
        }

    }
}

