@page "/"
@layout LoginLayout

@using Microsoft.AspNetCore.Components.Authorization
@using TicmansoV2.Authentication
@using TicmansoV2.Shared.Contracts
@using MudBlazor
@using System.Security.Claims
@using System.IdentityModel.Tokens.Jwt

@inject IUserAccount AccountRepository
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<PageTitle>Iniciar sesión</PageTitle>

<MudContainer>
    <MudGrid Justify="Justify.Center" AlignContent="AlignContent.Center" Class="loginGrid d-flex">
        <MudItem xs="12" sm="6">
            <EditForm Enhance Model="User" OnValidSubmit="HandleLogin" Class="LoginItem">
                <DataAnnotationsValidator />
                <MudCard Square="false" Class="LoginCard rounded-lg"
                         Style="box-shadow: 0 4px 6px rgba(100, 147, 181, 1), 0 1px 3px rgba(100, 147, 181, 0.5);">
                    <MudCardHeader>
                        <MudText Typo="Typo.h6">Inicio de sesión</MudText>
                        <MudImage Src="images/logo.png" Class="loginLogo"></MudImage>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudTextField @bind-Value="User.Email"
                                      Label="Dirección de correo"
                                      Variant="Variant.Outlined"
                                      Class="mb-3" />

                        <MudTextField @bind-Value="User.Password"
                                      Label="Contraseña"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Password" />
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Entrar</MudButton>
                        <MudButton ButtonType="ButtonType.Button" Variant="Variant.Filled" Color="Color.Transparent" Class="ml-auto" @onclick="ForgotPasswordForm">Olvide mi contrasena</MudButton>
                    </MudCardActions>
                </MudCard>
            </EditForm>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    public LoginDTO User { get; set; } = new();
    string userId;

    protected override async Task OnInitializedAsync()
    {
        var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "token");
        if (!string.IsNullOrEmpty(token))
        {

            NavigationManager.NavigateTo("/dashboard");

        }
    }
    async Task HandleLogin()
    {
        var (flag, token, message) = await AccountRepository.LoginAccount(User);
        if (flag)
        {
            // string customMessage = $"{message}{Environment.NewLine}{token}";
            // await JSRuntime.InvokeVoidAsync("alert", customMessage);
            // await 
            User = new();
            Snackbar.Add(message, Severity.Info);
            var customAuthStateProvider = (CustomAuthenticationStateProvider)AuthStateProvider;
            await customAuthStateProvider.UpdateAuthenticationState(token);
            NavManager.NavigateTo("/dashboard", forceLoad: true);
        }

        await JSRuntime.InvokeVoidAsync("alert", message);
        
        return;
    }

    void ForgotPasswordForm()
    {
        NavManager.NavigateTo("/forgot-paswword");
    }
}
