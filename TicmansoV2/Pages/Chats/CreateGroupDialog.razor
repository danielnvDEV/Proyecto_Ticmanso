@using System.Net.Http.Json
@using System.Security.Claims
@using System.IdentityModel.Tokens.Jwt;
@using TicmansoV2.Shared
@using MudBlazor
@inject ISnackbar Snackbar
@inject HttpClient httpClient
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Crear nuevo grupo</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField Required @bind-Value="GroupName" Label="Nombre del grupo" />
        <MudTextField Required @bind-Value="GroupDescription" Label="Descripción del grupo" />
        <MudSelect T="string" MultiSelection="true" SelectedValues="SelectedUserIds" SelectedValuesChanged="OnSelectedValuesChanged" Label="Usuarios">
            @foreach (var user in Users)
            {
                <MudSelectItem Value="@user.Id">@user.Name</MudSelectItem>
            }
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" OnClick="CreateGroup">Crear</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    [Parameter] public List<ApplicationUserDTO> Users { get; set; } = new List<ApplicationUserDTO>();

    private string GroupName { get; set; }
    private string GroupDescription { get; set; }

    
    private IEnumerable<ApplicationUserDTO> SelectedUsers { get; set; } = new List<ApplicationUserDTO>();
    private List<string> SelectedUserIds { get; set; } = new List<string>();

    protected override async Task OnInitializedAsync()
    {

        try
        {
            Users = await httpClient.GetFromJsonAsync<List<ApplicationUserDTO>>("api/Users");
        }
        catch (Exception)
        {
            Snackbar.Add($"Error al cargar la lista de usuarios", Severity.Error);
        }
        
    }
    private void Cancel()
    {
        MudDialog.Cancel();
    }
    private void OnSelectedValuesChanged(IEnumerable<string> values)
    {
        SelectedUserIds = new List<string>(values);
    }
    private async Task CreateGroup()
    {
        SelectedUsers = Users.Where(u => SelectedUserIds.Contains(u.Id)).ToList();

        var newGroup = new GroupDTO
        {
            Name = GroupName,
            Description = GroupDescription,
            CreatedAt = DateTime.Now,
            UserGroups = SelectedUsers.Select(u => new UserGroupDTO { UserId = u.Id }).ToList()
        };

        try
        {
            var response = await httpClient.PostAsJsonAsync("api/Group", newGroup);

            if (response.IsSuccessStatusCode)
            {
                MudDialog.Close(DialogResult.Ok(newGroup));
                Snackbar.Add($"El grupo se ha creado correctamente", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Error al crear el grupo", Severity.Error);
            }
        }
        catch (Exception e)
        {
            Snackbar.Add($"Error al crear el grupo", Severity.Error);
        }


    }
}
