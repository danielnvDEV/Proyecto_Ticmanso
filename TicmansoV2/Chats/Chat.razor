@using Microsoft.AspNetCore.SignalR.Client
@using System.Net.Http.Json
@using TicmansoV2.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.IdentityModel.Tokens.Jwt

@inject NavigationManager NavigationManager
@inject HttpClient httpClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

@page "/chat"
<div>
    <MudTextField @bind-Value="messageInput" Label="Mensaje" Variant="Variant.Outlined"></MudTextField>
    <MudButton OnClick="SendMessage" Variant="Variant.Filled" Color="Color.Primary">Enviar</MudButton>
</div>

<MudList>
    @foreach (var message in messages)
    {
        <MudListItem>
            <MudText>@message.SenderId: @message.Content</MudText>
            <MudText Typo="Typo.caption" Align="Align.End">@message.Timestamp</MudText>
        </MudListItem>
    }
</MudList>

@code {
    private HubConnection hubConnection;
    private List<ChatMessageDTO> messages = new List<ChatMessageDTO>();
    private string messageInput;
    string userId;
    protected override async Task OnInitializedAsync()
    {
        var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "token");
        var handler = new JwtSecurityTokenHandler();
        var jwtToken = handler.ReadJwtToken(token);
        var claims = jwtToken.Claims;
        userId = claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/chathub"))
            .Build();

        hubConnection.On<ChatMessageDTO>("ReceiveMessage", (message) =>
        {
            messages.Add(message);
            StateHasChanged();
        });

        await hubConnection.StartAsync();
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrEmpty(messageInput))
        {
            var message = new ChatMessageDTO
            {
                Content = messageInput,
                Timestamp = DateTime.Now,
                SenderId = userId,
                ReceiverId = "UsuarioDestinatarioId"
            };

            await hubConnection.SendAsync("SendMessage", message);
            messageInput = string.Empty;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}

